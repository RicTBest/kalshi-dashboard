<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Volume Executive Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 3px solid #007bff;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        h1 {
            color: #333;
            margin: 0;
            font-size: 1.8em;
        }
        .date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 6px;
        }
        .date-controls input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .date-controls span {
            color: #666;
            font-weight: 500;
        }
        .date-controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .date-controls button:hover {
            background: #0056b3;
        }
        .date-controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
            display: none;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            color: #666;
            margin-top: 5px;
        }
        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
        }
        .chart-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }
        canvas {
            max-height: 400px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #007bff;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .sport-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .sport-selector label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .sport-selector label:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .sport-selector input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .sport-selector label span {
            font-weight: 500;
        }
        .time-period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
            align-items: center;
        }
        .time-period-selector label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 6px 12px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .time-period-selector input[type="radio"]:checked + span {
            font-weight: bold;
        }
        .time-period-selector label:has(input:checked) {
            background: #007bff;
            color: white;
        }
        .time-period-selector input[type="radio"] {
            margin: 0;
        }
        @media (max-width: 768px) {
            .header-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .date-controls {
                width: 100%;
                justify-content: space-between;
            }
            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <h1>Sports Volume Executive Report</h1>
            <div class="date-controls">
                <input type="date" id="startDate" value="2025-08-01" min="2025-08-01">
                <span>to</span>
                <input type="date" id="endDate" value="2025-10-20" min="2025-08-01">
                <button onclick="loadReport()" id="loadBtn">Update</button>
            </div>
        </div>

```
    <div id="errorMessage" class="error"></div>
    <div id="loadingMessage" class="loading">Loading data...</div>

    <div id="report">
        <p><strong>Period:</strong> <span id="dateRange"></span></p>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="totalVolume">-</div>
                <div class="metric-label">Total Volume</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="sportsVolume">-</div>
                <div class="metric-label">Sports Volume</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="sportsPercent">-</div>
                <div class="metric-label">Sports % of Total</div>
            </div>
        </div>

        <h2>Sport Breakdown (% of Sports Volume)</h2>
        <table id="sportTable">
            <thead>
                <tr>
                    <th>Sport</th>
                    <th>Total Volume</th>
                    <th>% of Sports Volume</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="chart-container">
            <div class="chart-title">Sport Distribution</div>
            <canvas id="pieChart"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">Daily Total Volume Trend</div>
            <canvas id="dailyChart"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">Major Sports Trends Over Time</div>
            <div class="sport-selector" id="sportSelector"></div>
            <canvas id="trendsChart"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">Volume by Sport</div>
            <div class="time-period-selector">
                <strong>View by:</strong>
                <label>
                    <input type="radio" name="timePeriod" value="day" onchange="updateMonthlyChart()">
                    <span>Day</span>
                </label>
                <label>
                    <input type="radio" name="timePeriod" value="week" onchange="updateMonthlyChart()">
                    <span>Week</span>
                </label>
                <label>
                    <input type="radio" name="timePeriod" value="month" checked onchange="updateMonthlyChart()">
                    <span>Month</span>
                </label>
            </div>
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>
</div>

<script>
    let charts = {};
    let currentData = null;
    let allSportData = {};
    
    const sportColors = {
        'NFL': '#001F3F',
        'College Football': '#06B6D4',
        'MLB': '#4ADE80',
        'Golf': '#14B8A6',
        'Soccer': '#F97316',
        'NBA': '#8B5CF6',
        'WNBA': '#EC4899',
        'NHL': '#BAE6FD',
        'NCAAM': '#DC2626',
        'NCAAW': '#F472B6',
        'Motorsport': '#047857',
        'Tennis': '#FBBF24',
        'Combat': '#92400E'
    };

    // Set max date to yesterday
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    document.getElementById('endDate').max = yesterday.toISOString().split('T')[0];

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';
    }

    async function loadReport() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            showError('Please select both start and end dates');
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            showError('Start date must be before or equal to end date');
            return;
        }

        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('loadingMessage').style.display = 'block';
        document.getElementById('loadBtn').disabled = true;

        try {
            const response = await fetch(`/api/volumes?start_date=${startDate}&end_date=${endDate}`);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `API error: ${response.status}`);
            }

            const data = await response.json();
            
            if (!data || data.length === 0) {
                throw new Error('No data available for the selected date range');
            }

            console.log('Raw API data (first row):', data[0]);
            console.log('Total rows:', data.length);

            // Transform data - ensure all fields are properly converted to numbers
            const transformedData = data.map(row => {
                const transformed = {
                    date: row.date,
                    total_volume: Number(row.total_volume) || 0,
                    sports_volume: Number(row.sports_volume) || 0,
                    nfl_volume: Number(row.nfl_volume) || 0,
                    ncaaf_volume: Number(row.ncaaf_volume) || 0,
                    mlb_volume: Number(row.mlb_volume) || 0,
                    nba_volume: Number(row.nba_volume) || 0,
                    wnba_volume: Number(row.wnba_volume) || 0,
                    nhl_volume: Number(row.nhl_volume) || 0,
                    soccer_volume: Number(row.soccer_volume) || 0,
                    golf_volume: Number(row.golf_volume) || 0,
                    motorsport_volume: Number(row.motorsport_volume) || 0,
                    tennis_volume: Number(row.tennis_volume) || 0,
                    ncaam_volume: Number(row.ncaam_volume) || 0,
                    ncaaw_volume: Number(row.ncaaw_volume) || 0,
                    combat_volume: Number(row.combat_volume) || 0
                };
                return transformed;
            });

            console.log('Transformed data (first row):', transformedData[0]);

            document.getElementById('loadingMessage').style.display = 'none';
            generateReport(transformedData);
        } catch (error) {
            showError('Error loading data: ' + error.message);
            console.error('Load error:', error);
        } finally {
            document.getElementById('loadBtn').disabled = false;
        }
    }

    function generateReport(data) {
        currentData = data;
        
        // Clear previous charts
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};

        // Calculate totals - using Number() to ensure proper numeric addition
        let sums = {
            total: 0, sports: 0,
            nfl: 0, mlb: 0, nba: 0, wnba: 0, nhl: 0,
            soccer: 0, ncaaf: 0, golf: 0, motorsport: 0,
            ncaam: 0, ncaaw: 0, tennis: 0, combat: 0
        };

        data.forEach(d => {
            sums.total += Number(d.total_volume) || 0;
            sums.sports += Number(d.sports_volume) || 0;
            sums.nfl += Number(d.nfl_volume) || 0;
            sums.mlb += Number(d.mlb_volume) || 0;
            sums.nba += Number(d.nba_volume) || 0;
            sums.wnba += Number(d.wnba_volume) || 0;
            sums.nhl += Number(d.nhl_volume) || 0;
            sums.soccer += Number(d.soccer_volume) || 0;
            sums.ncaaf += Number(d.ncaaf_volume) || 0;
            sums.golf += Number(d.golf_volume) || 0;
            sums.motorsport += Number(d.motorsport_volume) || 0;
            sums.ncaam += Number(d.ncaam_volume) || 0;
            sums.ncaaw += Number(d.ncaaw_volume) || 0;
            sums.tennis += Number(d.tennis_volume) || 0;
            sums.combat += Number(d.combat_volume) || 0;
        });

        console.log('Calculated sums:', sums);
        
        // Verify individual sport sums add up to sports total
        const calculatedSportsTotal = sums.nfl + sums.mlb + sums.nba + sums.wnba + 
                                     sums.nhl + sums.soccer + sums.ncaaf + sums.golf + 
                                     sums.motorsport + sums.ncaam + sums.ncaaw + 
                                     sums.tennis + sums.combat;
        console.log('Sum of individual sports:', calculatedSportsTotal);
        console.log('Sports volume from data:', sums.sports);
        console.log('Difference:', Math.abs(calculatedSportsTotal - sums.sports));

        const sportsPercent = (sums.sports / sums.total * 100) || 0;

        // Update date range
        const firstDate = data[0].date;
        const lastDate = data[data.length - 1].date;
        document.getElementById('dateRange').textContent = 
            `${firstDate} - ${lastDate} (${data.length} days)`;

        // Update metrics - display exact values
        document.getElementById('totalVolume').textContent = (sums.total / 1e9).toFixed(3) + 'B';
        document.getElementById('sportsVolume').textContent = (sums.sports / 1e9).toFixed(3) + 'B';
        document.getElementById('sportsPercent').textContent = sportsPercent.toFixed(2) + '%';

        // Create table
        const sports = [
            { name: 'NFL', value: sums.nfl },
            { name: 'College Football', value: sums.ncaaf },
            { name: 'MLB', value: sums.mlb },
            { name: 'Golf', value: sums.golf },
            { name: 'Soccer', value: sums.soccer },
            { name: 'NBA', value: sums.nba },
            { name: 'WNBA', value: sums.wnba },
            { name: 'NHL', value: sums.nhl },
            { name: 'NCAAM', value: sums.ncaam },
            { name: 'NCAAW', value: sums.ncaaw },
            { name: 'Motorsport', value: sums.motorsport },
            { name: 'Tennis', value: sums.tennis },
            { name: 'Combat', value: sums.combat }
        ]
        .filter(sport => sport.value > 0)
        .sort((a, b) => b.value - a.value);

        console.log('Sports with volume:', sports.map(s => `${s.name}: ${s.value.toLocaleString()}`));

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        sports.forEach(sport => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = sport.name;
            
            // Format volume: show in B if >= 1 billion, otherwise M
            const volumeCell = row.insertCell(1);
            if (sport.value >= 1e9) {
                volumeCell.textContent = (sport.value / 1e9).toFixed(2) + 'B';
            } else {
                volumeCell.textContent = (sport.value / 1e6).toFixed(1) + 'M';
            }
            
            row.insertCell(2).textContent = (sport.value / sums.sports * 100).toFixed(2) + '%';
        });

        // Pie chart
        charts.pie = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: {
                labels: sports.map(s => s.name),
                datasets: [{
                    data: sports.map(s => s.value),
                    backgroundColor: sports.map(s => sportColors[s.name])
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                const pct = (ctx.parsed / sums.sports * 100).toFixed(2);
                                return ctx.label + ': ' + pct + '%';
                            }
                        }
                    }
                }
            }
        });

        // Daily trend chart
        charts.daily = new Chart(document.getElementById('dailyChart'), {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [{
                    label: 'Total Volume',
                    data: data.map(d => Number(d.total_volume) / 1e6),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: true,
                    tension: 0.1
                }, {
                    label: 'Sports Volume',
                    data: data.map(d => Number(d.sports_volume) / 1e6),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { 
                        beginAtZero: true,
                        title: { display: true, text: 'Volume (Millions)' }
                    },
                    x: { 
                        title: { display: true, text: 'Date' }
                    }
                }
            }
        });

        // Sport trends
        const allSports = [
            { name: 'NFL', key: 'nfl_volume' },
            { name: 'College Football', key: 'ncaaf_volume' },
            { name: 'MLB', key: 'mlb_volume' },
            { name: 'Golf', key: 'golf_volume' },
            { name: 'Soccer', key: 'soccer_volume' },
            { name: 'NBA', key: 'nba_volume' },
            { name: 'WNBA', key: 'wnba_volume' },
            { name: 'NHL', key: 'nhl_volume' },
            { name: 'NCAAM', key: 'ncaam_volume' },
            { name: 'NCAAW', key: 'ncaaw_volume' },
            { name: 'Motorsport', key: 'motorsport_volume' },
            { name: 'Tennis', key: 'tennis_volume' },
            { name: 'Combat', key: 'combat_volume' }
        ];

        const sportTotals = allSports.map(sport => {
            const total = data.reduce((sum, d) => sum + (Number(d[sport.key]) || 0), 0);
            return { ...sport, total };
        }).filter(sport => sport.total > 0).sort((a, b) => b.total - a.total);

        allSportData = {
            labels: data.map(d => d.date),
            sports: sportTotals.map(sport => ({
                name: sport.name,
                data: data.map(d => (Number(d[sport.key]) || 0) / 1e6)
            }))
        };

        const top4Sports = sportTotals.slice(0, 4).map(s => s.name);

        const selectorDiv = document.getElementById('sportSelector');
        selectorDiv.innerHTML = '';
        sportTotals.forEach(sport => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = sport.name;
            checkbox.checked = top4Sports.includes(sport.name);
            checkbox.onchange = updateTrendsChart;
            
            const span = document.createElement('span');
            span.textContent = sport.name;
            
            label.appendChild(checkbox);
            label.appendChild(span);
            selectorDiv.appendChild(label);
        });

        charts.trends = new Chart(document.getElementById('trendsChart'), {
            type: 'line',
            data: {
                labels: allSportData.labels,
                datasets: []
            },
            options: {
                responsive: true,
                scales: {
                    y: { 
                        beginAtZero: true,
                        title: { display: true, text: 'Volume (Millions)' }
                    }
                }
            }
        });

        updateTrendsChart();

        charts.monthly = new Chart(document.getElementById('monthlyChart'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: { display: true, text: 'Volume (Millions)' }
                    }
                }
            }
        });

        updateMonthlyChart();
    }

    function getWeekNumber(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return d.getFullYear() + '-W' + String(weekNo).padStart(2, '0');
    }

    function updateMonthlyChart() {
        if (!currentData || !charts.monthly) return;

        const timePeriod = document.querySelector('input[name="timePeriod"]:checked').value;
        const aggregated = {};

        currentData.forEach(d => {
            let key;
            const date = new Date(d.date);
            
            if (timePeriod === 'day') {
                key = d.date;
            } else if (timePeriod === 'week') {
                key = getWeekNumber(d.date);
            } else {
                key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }

            if (!aggregated[key]) {
                aggregated[key] = { 
                    nfl: 0, mlb: 0, ncaaf: 0, golf: 0, soccer: 0, 
                    nba: 0, wnba: 0, nhl: 0, ncaam: 0, ncaaw: 0, 
                    motorsport: 0, tennis: 0, combat: 0
                };
            }
            
            aggregated[key].nfl += Number(d.nfl_volume) || 0;
            aggregated[key].mlb += Number(d.mlb_volume) || 0;
            aggregated[key].ncaaf += Number(d.ncaaf_volume) || 0;
            aggregated[key].golf += Number(d.golf_volume) || 0;
            aggregated[key].soccer += Number(d.soccer_volume) || 0;
            aggregated[key].nba += Number(d.nba_volume) || 0;
            aggregated[key].wnba += Number(d.wnba_volume) || 0;
            aggregated[key].nhl += Number(d.nhl_volume) || 0;
            aggregated[key].ncaam += Number(d.ncaam_volume) || 0;
            aggregated[key].ncaaw += Number(d.ncaaw_volume) || 0;
            aggregated[key].motorsport += Number(d.motorsport_volume) || 0;
            aggregated[key].tennis += Number(d.tennis_volume) || 0;
            aggregated[key].combat += Number(d.combat_volume) || 0;
        });

        const periods = Object.keys(aggregated).sort((a, b) => {
            if (timePeriod === 'day') {
                return new Date(a) - new Date(b);
            }
            return a.localeCompare(b);
        });

        const sums = {
            nfl: 0, mlb: 0, ncaaf: 0, golf: 0, soccer: 0,
            nba: 0, wnba: 0, nhl: 0, ncaam: 0, ncaaw: 0, 
            motorsport: 0, tennis: 0, combat: 0
        };

        currentData.forEach(d => {
            sums.nfl += Number(d.nfl_volume) || 0;
            sums.mlb += Number(d.mlb_volume) || 0;
            sums.ncaaf += Number(d.ncaaf_volume) || 0;
            sums.golf += Number(d.golf_volume) || 0;
            sums.soccer += Number(d.soccer_volume) || 0;
            sums.nba += Number(d.nba_volume) || 0;
            sums.wnba += Number(d.wnba_volume) || 0;
            sums.nhl += Number(d.nhl_volume) || 0;
            sums.ncaam += Number(d.ncaam_volume) || 0;
            sums.ncaaw += Number(d.ncaaw_volume) || 0;
            sums.motorsport += Number(d.motorsport_volume) || 0;
            sums.tennis += Number(d.tennis_volume) || 0;
            sums.combat += Number(d.combat_volume) || 0;
        });

        const datasets = [];
        if (sums.nfl > 0) datasets.push({ label: 'NFL', data: periods.map(p => aggregated[p].nfl / 1e6), backgroundColor: sportColors['NFL'] });
        if (sums.ncaaf > 0) datasets.push({ label: 'College Football', data: periods.map(p => aggregated[p].ncaaf / 1e6), backgroundColor: sportColors['College Football'] });
        if (sums.mlb > 0) datasets.push({ label: 'MLB', data: periods.map(p => aggregated[p].mlb / 1e6), backgroundColor: sportColors['MLB'] });
        if (sums.golf > 0) datasets.push({ label: 'Golf', data: periods.map(p => aggregated[p].golf / 1e6), backgroundColor: sportColors['Golf'] });
        if (sums.soccer > 0) datasets.push({ label: 'Soccer', data: periods.map(p => aggregated[p].soccer / 1e6), backgroundColor: sportColors['Soccer'] });
        if (sums.nba > 0) datasets.push({ label: 'NBA', data: periods.map(p => aggregated[p].nba / 1e6), backgroundColor: sportColors['NBA'] });
        if (sums.wnba > 0) datasets.push({ label: 'WNBA', data: periods.map(p => aggregated[p].wnba / 1e6), backgroundColor: sportColors['WNBA'] });
        if (sums.nhl > 0) datasets.push({ label: 'NHL', data: periods.map(p => aggregated[p].nhl / 1e6), backgroundColor: sportColors['NHL'] });
        if (sums.ncaam > 0) datasets.push({ label: 'NCAAM', data: periods.map(p => aggregated[p].ncaam / 1e6), backgroundColor: sportColors['NCAAM'] });
        if (sums.ncaaw > 0) datasets.push({ label: 'NCAAW', data: periods.map(p => aggregated[p].ncaaw / 1e6), backgroundColor: sportColors['NCAAW'] });
        if (sums.motorsport > 0) datasets.push({ label: 'Motorsport', data: periods.map(p => aggregated[p].motorsport / 1e6), backgroundColor: sportColors['Motorsport'] });
        if (sums.tennis > 0) datasets.push({ label: 'Tennis', data: periods.map(p => aggregated[p].tennis / 1e6), backgroundColor: sportColors['Tennis'] });
        if (sums.combat > 0) datasets.push({ label: 'Combat', data: periods.map(p => aggregated[p].combat / 1e6), backgroundColor: sportColors['Combat'] });

        charts.monthly.data.labels = periods;
        charts.monthly.data.datasets = datasets;
        charts.monthly.update();
    }

    function updateTrendsChart() {
        if (!charts.trends || !allSportData) return;

        const checkboxes = document.querySelectorAll('#sportSelector input[type="checkbox"]');
        const selectedSports = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        const datasets = allSportData.sports
            .filter(sport => selectedSports.includes(sport.name))
            .map(sport => ({
                label: sport.name,
                data: sport.data,
                borderColor: sportColors[sport.name],
                backgroundColor: sportColors[sport.name] + '33',
                fill: true,
                tension: 0.1
            }));

        charts.trends.data.datasets = datasets;
        charts.trends.update();
    }

    // Auto-load report on page load
    window.addEventListener('DOMContentLoaded', () => {
        loadReport();
    });
</script>
```

</body>
</html>
